<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C Programming Problem Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Smooth scrolling for anchor links */
        html {
            scroll-behavior: smooth;
        }
        /* Custom scrollbar for a cleaner look in code areas */
        textarea::-webkit-scrollbar,
        aside::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track,
        aside::-webkit-scrollbar-track {
            background: #f1f5f9; /* gray-100 */
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb,
        aside::-webkit-scrollbar-thumb {
            background: #94a3b8; /* gray-400 */
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover,
        aside::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* gray-500 */
        }
        /* Style for checked card - NO opacity change */
        .problem-card.completed {
            background-color: #f0f9ff; /* light blue background */
            border-left: 4px solid #3b82f6; /* blue accent border */
        }
        .problem-card.completed h3 {
            color: #1e40af; /* darker blue for title */
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease, visibility 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <!-- Mobile Menu Toggle Button -->
    <button id="menu-toggle" class="fixed top-4 left-4 z-50 lg:hidden bg-white p-2 rounded-md shadow-md text-gray-600 hover:text-gray-900">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
        </svg>
    </button>

    <!-- Overlay for Mobile Menu -->
    <div id="overlay" class="fixed inset-0 z-30 bg-black opacity-0 pointer-events-none transition-opacity duration-300 lg:hidden"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 z-40 w-64 h-screen bg-white shadow-xl p-6 overflow-y-auto transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0">
        <h2 class="text-2xl font-bold text-indigo-700 mb-6">Categories</h2>
        <nav id="sidebar-nav" class="space-y-2">
            <!-- Sidebar links will be injected here by JS -->
        </nav>
    </aside>

    <!-- Main Content Area -->
    <div role="main" class="flex-1 transition-all duration-300 lg:ml-64">
        <div class="max-w-4xl mx-auto p-6 md:p-10">
            <!-- Header -->
            <header class="mb-10">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">C Programming Tracker</h1>
                <p class="text-xl text-gray-600 mb-6">Track your progress on these logic-building problems.</p>
                
                <!-- Search Bar -->
                <div>
                    <input 
                        type="text" 
                        id="search-bar" 
                        placeholder="Search for a problem..." 
                        class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-transparent shadow-sm"
                    >
                </div>
            </header>

            <!-- Container where problems will be injected by JavaScript -->
            <main id="problem-list-container" class="space-y-8">
                <!-- Problems will be dynamically generated here -->
            </main>
        </div>
    </div>

    <!-- "Add Problem" Floating Action Button -->
    <button id="add-problem-btn" class="fixed bottom-8 right-8 z-40 w-16 h-16 bg-indigo-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-indigo-700 transition-all">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
    </button>

    <!-- "Add Problem" Modal -->
    <div id="add-problem-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 opacity-0 invisible transition-all duration-300">
        <div class="modal-content bg-white w-full max-w-lg p-6 rounded-lg shadow-xl transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Add a New Problem</h2>
            <form id="add-problem-form">
                <div class="space-y-4">
                    <div>
                        <label for="new-problem-category" class="block text-sm font-medium text-gray-700">Category</label>
                        <input 
                            type="text" 
                            id="new-problem-category"
                            list="category-list"
                            required
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            placeholder="e.g., Loops or New Category"
                        >
                        <datalist id="category-list">
                            <!-- Category options will be populated by JS -->
                        </datalist>
                    </div>
                    <div>
                        <label for="new-problem-title" class="block text-sm font-medium text-gray-700">Problem Title</label>
                        <input 
                            type="text" 
                            id="new-problem-title"
                            required
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            placeholder="e.g., 3. Find the Median"
                        >
                    </div>
                    <div>
                        <label for="new-problem-description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea 
                            id="new-problem-description" 
                            rows="3"
                            required
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            placeholder="Describe the problem..."
                        ></textarea>
                    </div>
                    <div>
                        <label for="new-problem-example" class="block text-sm font-medium text-gray-700">Example / Hint (Optional)</label>
                        <textarea 
                            id="new-problem-example" 
                            rows="2"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                            placeholder="e.g., Input: [1, 2, 3] Output: 2"
                        ></textarea>
                    </div>
                </div>
                <!-- Form Buttons -->
                <div class="mt-6 flex justify-end gap-4">
                    <button type="button" id="modal-cancel-btn" class="py-2 px-4 bg-gray-100 text-gray-700 font-medium rounded-md hover:bg-gray-200">
                        Cancel
                    </button>
                    <button type="submit" id="modal-save-btn" class="py-2 px-4 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700">
                        Save Problem
                    </button>
                </div>
            </form>
        </div>
    </div>
<script>
    // --- DATA: All the problems, organized by category ---
    const defaultCategories = [
        {
            title: "Loops & Number Logic",
            icon: "repeat",
            problems: [
                {
                    id: "loops-1",
                    title: "1. Print Unique Numbers from User Input",
                    description: "Ask the user to enter 10 integers. Store them in an array. Then, iterate through the array and print only the numbers that are appearing for the *first* time.",
                    example: "Example Input: 5, 10, 2, 10, 5, 3, 2, 9\nExample Output: 5, 10, 2, 3, 9"
                },
                {
                    id: "loops-2",
                    title: "2. Reverse a Number",
                    description: "Read an integer from the user and print its reverse.",
                    example: "Example Input: 12345\nExample Output: 54321"
                }
            ]
        },
        {
            title: "Pattern Printing (Nested Loops)",
            icon: "palette",
            problems: [
                {
                    id: "patterns-1",
                    title: "1. Number Pyramid",
                    description: "Write a program to print a pyramid of numbers for a given height N.",
                    example: "Example (N=4):\n   1\n  232\n 34543\n4567654"
                },
                {
                    id: "patterns-2",
                    title: "2. Floyd's Triangle",
                    description: "Write a program to print the first N rows of Floyd's Triangle.",
                    example: "Example (N=4):\n1\n2  3\n4  5  6\n7  8  9  10"
                }
            ]
        },
        {
            title: "1D Arrays",
            icon: "folder",
            problems: [
                {
                    id: "arrays-1",
                    title: "1. Find Second Largest",
                    description: "Write a program that finds the second largest element in an array of integers. Try to do this in a single pass (i.e., with only one loop).",
                    example: "Hint: Keep track of both the `largest` and `secondLargest` numbers as you iterate."
                },
                {
                    id: "arrays-2",
                    title: "2. Rotate Array",
                    description: "Write a function to rotate an array of N elements to the right by K steps. (Challenge: Can you do this *in-place*?)",
                    example: "Example: arr = [1, 2, 3, 4, 5], K = 2\nResult: [4, 5, 1, 2, 3]"
                }
            ]
        },
        {
            title: "Strings (Arrays & Pointers)",
            icon: "file-text",
            problems: [
                {
                    id: "strings-1",
                    title: "1. Extract Vowels",
                    description: "Read a string from the user. Create a new string that contains only the vowels (a, e, i, o, u) from the original string, preserving their order.",
                    example: "Example Input: This is a test string.\nExample Output: iiaei"
                },
                {
                    id: "strings-2",
                    title: "2. Reverse String (In-Place)",
                    description: "Write a function `void reverseString(char *str)`. This function takes a string (as a character pointer) and reverses it in-place (without creating a new array).",
                    example: "Example: \"hello\" becomes \"olleh\""
                },
                {
                    id: "strings-3",
                    title: "3. Check for Palindrome",
                    description: "Write a function `int isPalindrome(char *str)` that returns 1 if the string is a palindrome, and 0 if it is not.",
                    example: "Palindromes: \"racecar\", \"madam\", \"level\""
                },
                {
                    id: "strings-4",
                    title: "4. Find Most Frequent Character",
                    description: "Read a string and find the character that appears most frequently. If there's a tie, print the one that appeared first.",
                    example: "Example Input: hello world\nExample Output: l (it appears 3 times)"
                }
            ]
        },
        {
            title: "2D Arrays (Matrices)",
            icon: "grid-3x3",
            problems: [
                {
                    id: "matrix-1",
                    title: "1. Boundary Sum",
                    description: "Write a program to read a 4x4 matrix from the user. Then, calculate and print the sum of all elements on the boundary of the matrix.",
                    example: "This includes the first row, last row, first column, and last column."
                }
            ]
        },
        {
            title: "Functions & Recursion",
            icon: "gear",
            problems: [
                {
                    id: "functions-1",
                    title: "1. Prime Number Finder",
                    description: "Write a function `int isPrime(int num)`. This function should return 1 if `num` is a prime number and 0 otherwise. In `main()`, use this function to print all prime numbers between 1 and 100."
                },
                {
                    id: "functions-2",
                    title: "2. Binary Search",
                    description: "Write a function that searches for a `target` number in a *sorted* array using the Binary Search algorithm.",
                    example: "[Image of binary search algorithm diagram]\nLogic: Check the middle. If target is smaller, search the left half. If larger, search the right half. Repeat."
                },
                {
                    id: "functions-3",
                    title: "3. Count Occurrences (Recursion)",
                    description: "Write a recursive function `int countOccurrences(char *str, char target)`. This function should return the total number of times the `target` character appears in the `str`.",
                    example: "Example Call: countOccurrences(\"mississippi\", 's')\nShould return: 4"
                },
                {
                    id: "functions-4",
                    title: "4. Fibonacci Sequence (Recursion vs. Loops)",
                    description: "Write a function to get the N-th number in the Fibonacci sequence (0, 1, 1, 2, 3, 5, 8...).\nTask 1: Write it using a loop (iteratively).\nTask 2: Write it using recursion."
                }
            ]
        },
        {
            title: "Structures",
            icon: "person",
            problems: [
                {
                    id: "structs-1",
                    title: "1. Filter Books by Price",
                    description: "Define a `struct Book` containing `book_id` (int), `title` (char array), and `price` (float). Create an array of 5 `struct Book` variables, get the details, and print the `title` of all books that cost more than 500.0."
                },
                {
                    id: "structs-2",
                    title: "2. Sort Student Records",
                    description: "Define a `struct Student` with `char name[50]` and `int marks`. Create an array of 5 `Student` objects. Get their details, then sort the entire array in descending order based on `marks` and print the sorted list."
                }
            ]
        },
        {
            title: "File Handling",
            icon: "folder",
            problems: [
                {
                    id: "files-1",
                    title: "1. Copy Lines by Condition",
                    description: "Read from `File1.txt`. Create a new file, `File2.txt`, and copy only the lines from `File1.txt` that start with an uppercase letter.",
                    example: "Hint: You'll need to keep track of whether you are at the beginning of a new line."
                }
            ]
        }
    ];

    // --- CORE LOGIC ---
    const API_BASE = '/api';
    
    let completedProblems = {};
    let customCategories = [];
    let codeSolutions = {};

    // Helper to create a URL-friendly ID
    function sanitizeTitleForId(title) {
        return `category-${title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '')}`;
    }

    // Function to get icon HTML
    function getIconHTML(iconName, size = 'text-xl') {
        const iconMap = {
            'repeat': `<svg class="w-5 h-5 ${size}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>`,
            'palette': `<svg class="w-5 h-5 ${size}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
            </svg>`,
            'folder': `<svg class="w-5 h-5 ${size}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
            </svg>`,
            'file-text': `<svg class="w-5 h-5 ${size}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>`,
            'grid-3x3': `<svg class="w-5 h-5 ${size}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
            </svg>`,
            'gear': `<svg class="w-5 h-5 ${size}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>`,
            'person': `<svg class="w-5 h-5 ${size}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>`,
            'default': `<svg class="w-5 h-5 ${size}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>`
        };
        
        return iconMap[iconName] || iconMap['default'];
    }

    // --- Data Aggregation ---
    function getAggregatedCategories() {
        const aggregated = new Map();

        // 1. Add default categories to map
        defaultCategories.forEach(c => {
            aggregated.set(c.title, { 
                icon: c.icon, 
                problems: [...c.problems]
            });
        });

        // 2. Add/merge custom categories
        customCategories.forEach(customCat => {
            if (aggregated.has(customCat.title)) {
                aggregated.get(customCat.title).problems.push(...customCat.problems);
            } else {
                aggregated.set(customCat.title, { 
                    icon: customCat.icon || 'default', 
                    problems: [...customCat.problems] 
                });
            }
        });
        
        // 3. Convert map back to an array
        const allCategories = [];
        aggregated.forEach((value, key) => {
            allCategories.push({ 
                title: key, 
                icon: value.icon, 
                problems: value.problems 
            });
        });
        
        return allCategories;
    }

    // --- API Functions ---
    async function loadState() {
        try {
            const response = await fetch(`${API_BASE}/data`);
            const data = await response.json();
            
            completedProblems = data.completed || {};
            customCategories = data.customCategories || [];
            codeSolutions = data.codeSolutions || {};
        } catch (error) {
            console.error('Failed to load data from server:', error);
            // Initialize with empty data if server fails
            completedProblems = {};
            customCategories = [];
            codeSolutions = {};
        }
    }

    async function saveCompletedState(problemId, isChecked) {
        try {
            await fetch(`${API_BASE}/complete`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ problemId, isChecked })
            });
        } catch (error) {
            console.error('Failed to save completion state:', error);
        }
    }
    
    async function saveCodeSolution(problemId, code) {
        try {
            await fetch(`${API_BASE}/code`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ problemId, code })
            });
        } catch (error) {
            console.error('Failed to save code:', error);
        }
    }

    async function saveNewProblem(problemData) {
        try {
            const response = await fetch(`${API_BASE}/problems`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(problemData)
            });
            
            if (response.ok) {
                const result = await response.json();
                return result;
            } else {
                throw new Error('Failed to save problem');
            }
        } catch (error) {
            console.error('Failed to save new problem:', error);
            throw error;
        }
    }

    // 3. Render all problems onto the page
    function renderProblems() {
        const container = document.getElementById('problem-list-container');
        const sidebarNav = document.getElementById('sidebar-nav');
        container.innerHTML = ''; // Clear existing content
        sidebarNav.innerHTML = ''; // Clear existing sidebar links

        const allCategories = getAggregatedCategories();

        allCategories.forEach(category => {
            const categoryId = sanitizeTitleForId(category.title);

            // --- A: Create Sidebar Link ---
            const sidebarLink = document.createElement('a');
            sidebarLink.href = `#${categoryId}`;
            sidebarLink.className = 'flex items-center gap-3 py-2 px-4 rounded font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600';
            sidebarLink.innerHTML = `${getIconHTML(category.icon, 'text-lg')} <span>${category.title}</span>`;
            sidebarLink.onclick = closeMobileMenu;
            sidebarNav.appendChild(sidebarLink);

            // --- B: Create Category Section in Main Content ---
            const categorySection = document.createElement('section');
            categorySection.className = 'category-section';
            categorySection.id = categoryId;

            // Create category title
            const categoryHeader = document.createElement('h2');
            categoryHeader.className = 'text-3xl font-semibold text-gray-700 mb-6 mt-8 flex items-center gap-3';
            categoryHeader.innerHTML = `${getIconHTML(category.icon, 'text-2xl')} ${category.title}`;
            categorySection.appendChild(categoryHeader);

            // Create container for this category's problems
            const problemSection = document.createElement('div');
            problemSection.className = 'grid grid-cols-1 gap-4'; 
            
            category.problems.forEach(problem => {
                const isCompleted = completedProblems[problem.id] || false;
                const savedCode = codeSolutions[problem.id] || '';
                
                const card = document.createElement('div');
                card.id = `problem-${problem.id}`;
                card.className = `problem-card bg-white shadow-lg rounded-xl p-6 transition-all hover:shadow-xl ${isCompleted ? 'completed' : ''}`;
                
                const formattedDescription = (problem.description || '').replace(/\n/g, '<br>');
                const formattedExample = problem.example ? 
                    `<pre class="bg-gray-50 p-4 rounded-md text-sm text-gray-800 mt-4 whitespace-pre-wrap font-mono">${problem.example}</pre>` : 
                    '';

                card.innerHTML = `
                    <div class="flex justify-between items-start gap-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-semibold text-indigo-700 mb-2">${problem.title}</h3>
                            <p class="text-gray-700 whitespace-pre-wrap">${formattedDescription}</p>
                            ${formattedExample}
                        </div>
                        <div>
                            <label for="checkbox-${problem.id}" class="flex items-center gap-2 text-gray-600 font-medium cursor-pointer p-2 rounded-md hover:bg-gray-100">
                                <input 
                                    type="checkbox" 
                                    id="checkbox-${problem.id}" 
                                    data-problem-id="${problem.id}"
                                    class="h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                    ${isCompleted ? 'checked' : ''}
                                >
                                <span>Completed</span>
                            </label>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button 
                            class="toggle-code-btn text-sm font-medium text-indigo-600 hover:text-indigo-800 py-1"
                            data-target-id="code-wrapper-${problem.id}"
                        >
                            Show Code
                        </button>
                        <div id="code-wrapper-${problem.id}" class="hidden mt-3">
                            <label for="code-${problem.id}" class="text-sm font-medium text-gray-600 mb-2 block">Your Code Solution:</label>
                            <textarea 
                                id="code-${problem.id}"
                                data-problem-id="${problem.id}"
                                class="code-textarea w-full h-48 p-4 font-mono text-sm bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-y"
                                placeholder="Paste your C code here..."
                            >${savedCode}</textarea>
                        </div>
                    </div>
                `;
                problemSection.appendChild(card);
            });
            
            categorySection.appendChild(problemSection);
            container.appendChild(categorySection);
        });
    }

    // 4. Handle checkbox clicks
    function handleCheckboxChange(checkbox) {
        const problemId = checkbox.dataset.problemId;
        const isChecked = checkbox.checked;
        
        // Update local state immediately for UI responsiveness
        completedProblems[problemId] = isChecked;
        const card = document.getElementById(`problem-${problemId}`);
        if (isChecked) {
            card.classList.add('completed');
        } else {
            card.classList.remove('completed');
        }
        
        // Save to server
        saveCompletedState(problemId, isChecked);
    }

    // 5. Handle "Show Code" button clicks
    function handleToggleCode(button) {
        const targetId = button.dataset.targetId;
        const codeWrapper = document.getElementById(targetId);
        if (codeWrapper) {
            const isHidden = codeWrapper.classList.toggle('hidden');
            button.textContent = isHidden ? 'Show Code' : 'Hide Code';
        }
    }

    // 6. Handle code textarea changes with debouncing
    let codeSaveTimeout;
    function handleCodeChange(textarea) {
        const problemId = textarea.dataset.problemId;
        const code = textarea.value;
        
        // Update local state immediately
        codeSolutions[problemId] = code;
        
        // Debounce server save to avoid too many requests
        clearTimeout(codeSaveTimeout);
        codeSaveTimeout = setTimeout(() => {
            saveCodeSolution(problemId, code);
        }, 1000);
    }

    // 7. Handle main click events (delegation)
    function handleContainerClick(event) {
        const target = event.target;
        if (target.type === 'checkbox' && target.dataset.problemId) {
            handleCheckboxChange(target);
            return;
        }
        if (target.classList.contains('toggle-code-btn')) {
            handleToggleCode(target);
            return;
        }
    }

    // 8. Handle textarea input events (delegation)
    function handleContainerInput(event) {
        const target = event.target;
        if (target.classList.contains('code-textarea')) {
            handleCodeChange(target);
            return;
        }
    }

    // 9. Handle search bar input
    function handleSearch(event) {
        const searchTerm = event.target.value.toLowerCase();
        const categories = document.querySelectorAll('.category-section');
        const sidebarLinks = document.querySelectorAll('#sidebar-nav a');

        categories.forEach((category, index) => {
            let categoryHasVisibleProblem = false;
            const problems = category.querySelectorAll('.problem-card');

            problems.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                const description = card.querySelector('p').textContent.toLowerCase();
                
                if (title.includes(searchTerm) || description.includes(searchTerm)) {
                    card.style.display = 'block';
                    categoryHasVisibleProblem = true;
                } else {
                    card.style.display = 'none';
                }
            });

            // Show/hide category section and sidebar link
            const sidebarLink = sidebarLinks[index];
            if (categoryHasVisibleProblem) {
                category.style.display = 'block';
                sidebarLink.style.display = 'flex';
            } else {
                category.style.display = 'none';
                sidebarLink.style.display = 'none';
            }
        });
    }

    // --- Modal Logic ---
    const modal = document.getElementById('add-problem-modal');
    const modalContent = modal.querySelector('.modal-content');
    const addProblemBtn = document.getElementById('add-problem-btn');
    const cancelBtn = document.getElementById('modal-cancel-btn');
    const addProblemForm = document.getElementById('add-problem-form');
    const categoryDatalist = document.getElementById('category-list');

    function openModal() {
        // Populate category datalist
        const allCategories = getAggregatedCategories();
        categoryDatalist.innerHTML = '';
        allCategories.forEach(c => {
            categoryDatalist.innerHTML += `<option value="${c.title}"></option>`;
        });

        // Show modal
        modal.classList.remove('opacity-0', 'invisible');
        modalContent.classList.remove('scale-95');
    }

    function closeModal() {
        modal.classList.add('opacity-0', 'invisible');
        modalContent.classList.add('scale-95');
        addProblemForm.reset();
    }
    
    async function handleSaveProblem(event) {
        event.preventDefault();
        
        // 1. Get data from form
        const categoryTitle = document.getElementById('new-problem-category').value.trim();
        const title = document.getElementById('new-problem-title').value.trim();
        const description = document.getElementById('new-problem-description').value.trim();
        const example = document.getElementById('new-problem-example').value.trim();
        
        // 2. Validate required fields
        if (!categoryTitle || !title || !description) {
            alert("Please fill in Category, Title, and Description.");
            return;
        }
        
        try {
            // 3. Save to server
            await saveNewProblem({
                categoryTitle,
                title,
                description,
                example
            });
            
            // 4. Reload data from server to get the updated state
            await loadState();
            
            // 5. Re-render the entire list
            renderProblems();
            
            // 6. Close modal
            closeModal();
            
            // 7. Show success message
            alert('Problem added successfully!');
            
        } catch (error) {
            alert('Failed to save problem. Please try again.');
        }
    }

    // 10. Mobile Menu Toggle Logic
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menu-toggle');
    const overlay = document.getElementById('overlay');

    function openMobileMenu() {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('opacity-0', 'pointer-events-none');
    }

    function closeMobileMenu() {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('opacity-0', 'pointer-events-none');
    }

    // 11. Initialize the app
    document.addEventListener('DOMContentLoaded', async () => {
        // Load initial data from server
        await loadState();
        renderProblems();
        
        const container = document.getElementById('problem-list-container');
        container.addEventListener('click', handleContainerClick);
        container.addEventListener('input', handleContainerInput);
        
        const searchBar = document.getElementById('search-bar');
        searchBar.addEventListener('input', handleSearch);

        // Setup menu toggle
        menuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            if (sidebar.classList.contains('-translate-x-full')) {
                openMobileMenu();
            } else {
                closeMobileMenu();
            }
        });
        overlay.addEventListener('click', closeMobileMenu);
        
        // Setup modal triggers
        addProblemBtn.addEventListener('click', openModal);
        cancelBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
        addProblemForm.addEventListener('submit', handleSaveProblem);
    });
</script>
</body>
</html>